
var fs = require('fs'), r = fs.readFile, w = fs.writeFile, rs = fs.readFileSync, ws = fs.writeFileSync, es = fs.existsSync,
str = function(o){ return JSON.stringify(o, null, 4) }, ki = fs.unlink, safew = function(o){delete o.stack; delete o.length; delete o.use; delete o.set; delete o.wipe; return JSON.stringify(o, null, 4)};

function db(def, filename){
	var fn = filename || './db.json';
	es(fn) || ws(fn, str(def || {}));
	var ret = JSON.parse(rs(fn).toString()); 
	ret.stack = []; ret.use = function(f) { ret.stack.push(f) };
	ret.set = function(n, v, cb){
		ret.stack.forEach(function(si){
			v = si(v) || v;
		})
		ret[n] = v;
		var o = JSON.parse(str(ret));
		var dbc = safew(o);
		cb ? w(fn, dbc, cb) : w(fn, dbc);
	}
	ret.wipe = function(){ ki(filename) }
	return ret;
}

module.exports = db;

